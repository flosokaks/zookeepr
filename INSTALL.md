Zookeepr Installation Instructions
==================================

Setup on tuxfamily
==================

Patch pip like this :

https://github.com/pypa/pip/issues/3017

    export PYTHONPATH=/home/kansaslf/kansaslinuxfest.tuxfamily.org-web/php-include/install//lib/python2.7/site-packages/

Remove the old ~/.local

    rm ~/.local/

symlink in the target dir into .local because pip does not change all locations

    ln -s /home/kansaslf/kansaslinuxfest.tuxfamily.org-web/php-include/install ~/.local
  
create a temp dir:

    mkdir -p /home/kansaslf/kansaslinuxfest.tuxfamily.org-web/php-include/install/tmp

setup your path : 

    export PATH=$PATH:~/kansaslf/kansaslinuxfest.tuxfamily.org-web/php-include/install/bin/

run pip:

    pip install  -r requirements.txt  --no-cache-dir --user


External dependencies
---------------------

 * libpq-dev
 * libpython-dev
 * libxslt1-dev
 * libxml2-dev
 * postgresql
 * python-virtualenv

I have upgraded to : https://github.com/Pylons/pylons and
https://github.com/Pylons/webob

```
git clone git@github.com:flosokaks/zookeepr.git
cd zookeepr/
sudo apt-get install python-elementtidy libpq-dev libpython-dev libxslt1-dev
libxml2-dev python-authkit postgresql-9.4 python-virtualenv
pip install --user --upgrade -r requirements.txt

as postgres: su - postgres

pg_createcluster 9.4 main
pg_ctlcluster 9.4 main start
createuser --no-createdb --no-createrole --no-superuser zookeepr
createdb -O zookeepr zk
psql --command "ALTER USER zookeepr with PASSWORD 'zookeepr'"


cp development.ini.sample development.ini
vi development.ini
```

Change this line :
```
sqlalchemy.url = postgresql://kansaslf_zookeepr:XXXXPASSWORDXXXX@sql/kansaslf_zookeepr
```

```
git cherry-pick daa1702ec4522a991c5f75b17cb27e15375d2631
alembic --config development.ini history
alembic --config development.ini upgrade head
git reset --hard HEAD^

pserve --reload development.ini
```

Here is that patch :

mdupont@mdupont-Aspire-7750G:~/experiments/zookeepr$ git log -1 daa1702ec4522a991c5f75b17cb27e15375d2631 --patch
commit daa1702ec4522a991c5f75b17cb27e15375d2631
Author: Francois Marier <francois@fmarier.org>
Date:   Sat May 2 17:39:07 2015 +1000

    DO NOT MERGE THIS BRANCH INTO TRUNK
    
     * Comment out 2x op.execute commands that conflict with the default data load
     * Create fake head revision that will ensure the initial DB load happens after the schema has loaded
     * Remove initial DB load from first alembic commit

diff --git a/alembic/versions/1b85d3dd8d84_.py b/alembic/versions/1b85d3dd8d84_.py
new file mode 100644
index 0000000..8d50199
--- /dev/null
+++ b/alembic/versions/1b85d3dd8d84_.py
@@ -0,0 +1,29 @@
+"""
+* This revision is a lie and should always be head
+
+Revision ID: 1b85d3dd8d84
+Revises: 3b1b405d632e
+Create Date: 2012-09-24 03:55:51.729799
+
+"""
+from zk import model
+from zk.model import meta
+
+# revision identifiers, used by Alembic.
+revision = '1b85d3dd8d84'
+down_revision = '590a0265a5f'
+
+from alembic import op
+import sqlalchemy as sa
+
+
+def upgrade():
+    ### initial database load ###
+    engine = op.get_bind()
+    model.init_model(engine)
+    meta.Base.metadata.create_all(engine)
+    model.setup(meta)
+    ### end initial database load ###
+
+def downgrade():
+    pass
diff --git a/alembic/versions/209af87cb54_.py b/alembic/versions/209af87cb54_.py
index e33abb7..5c98fc5 100644
--- a/alembic/versions/209af87cb54_.py
+++ b/alembic/versions/209af87cb54_.py
@@ -16,8 +16,9 @@ import sqlalchemy as sa
 
 
 def upgrade():
+    pass
     ### commands auto generated by Alembic - please adjust! ###
-    op.execute("INSERT INTO proposal_status (name) VALUES ('Offered Travel'), ('Offered Accommodation'), ('Offered Travel Accommodation')")
+#    op.execute("INSERT INTO proposal_status (name) VALUES ('Offered Travel'), ('Offered Accommodation'), ('Offered Travel Accommodation')")
     ### end Alembic commands ###
 
 
diff --git a/alembic/versions/2742a682f066_.py b/alembic/versions/2742a682f066_.py
index f542fb4..5de700f 100644
--- a/alembic/versions/2742a682f066_.py
+++ b/alembic/versions/2742a682f066_.py
@@ -27,7 +27,7 @@ def upgrade():
     sa.PrimaryKeyConstraint('id'),
     sa.UniqueConstraint('person_id')
     )
-    op.execute("INSERT INTO proposal_status (name) VALUES ('Offered'), ('Contact')")
+#    op.execute("INSERT INTO proposal_status (name) VALUES ('Offered'), ('Contact')")
     ### end Alembic commands ###
 
 
diff --git a/alembic/versions/2daf319bbf1_.py b/alembic/versions/2daf319bbf1_.py
index e572282..280c446 100644
--- a/alembic/versions/2daf319bbf1_.py
+++ b/alembic/versions/2daf319bbf1_.py
@@ -574,14 +574,6 @@ def upgrade():
     )
     ### end Alembic commands ###
 
-    ### initial database load ###
-    engine = op.get_bind()
-    model.init_model(engine)
-    meta.Base.metadata.create_all(engine)
-    model.setup(meta)
-    ### end initial database load ###
-
-
 def downgrade():
     ### commands auto generated by Alembic - please adjust! ###
     op.drop_table('payment_allocation')


Creating a development environment
----------------------------------

1. Create a postgresql database for your ZooKeepr instance. The first command creates the database user, the second the database itself, with the zookeepr user as the admin user, and the third assigns a password to the zookeepr user.

    ```
    sudo -u postgres createuser --no-createdb --no-createrole --no-superuser zookeepr
    sudo -u postgres createdb -O zookeepr zk
    sudo -u postgres psql --command "ALTER USER zookeepr with PASSWORD 'zookeepr'"
    ```

2. Create a virtualenv for your ZooKeepr instance.
        ```
        \# using only virtualenv
        virtualenv env --no-site-packages
        . ./env/bin/activate

        \# using virtualenwrapper
        mkvirtualenv zookeepr # --no-site-packages is default
        workon zookeepr
        ```

3. Configure the virtual environment.

        ```
        cp zkpylons/config/klf_info.py.sample zkpylons/config/klf_info.py
        cp development.ini.sample development.ini
        python setup.py develop
        ```

    Edit development.ini to set sqlachemy.url to match your postgresql database.
    _Note: You must set sqlachemy.url in both the [app:main] and [alembic] sections_

4. Now we populate the database. Run alembic to create and populate the initial database.
        ```
        alembic --config development.ini upgrade head
        ```

        WARNING: On a vanilla trunk this does not currently work but there
        is a workaround:

            * Zookeepr is using alembic in a rather unusual way, which leads to
            problems. James has a work-around for this, but it is not currently in
            master and should never be committed to master. The work-around can be
            cherry-picked, commit daa1702ec4522a991c5f75b17cb27e15375d2631 from
            the nasty-db-import-fix branch.

            ```
            git cherry-pick daa1702ec4522a991c5f75b17cb27e15375d2631
            alembic --config development.ini upgrade head
            ```

            To verify the fix, use the alembic history command and check that the
            head revision is "This revision is a lie and should always be head".
            `alembic --config development.ini history`

            ```
            git reset --hard HEAD^
            ```

            Now, we verify that the revision is no longer present, using the command;
            `alembic --config development.ini history`

            The phrase 'This revision is a lie' should *no longer* be present.

5. Run the development server.
        ```
        pserve --reload development.ini
        ```

6. The default admin account is:
        ```
        email: admin@zookeepr.org
        password: password
        ```

You should now have a development instance of ZooKeepr up and running.

Access it at: <http://0.0.0.0:6543>

*Congratulations*



